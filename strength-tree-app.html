<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜ç‚¹æ ‘ - å‘ç°å­©å­çš„é—ªå…‰ç‚¹</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¼˜ç‚¹æ ‘</h1>
        </header>
        
        <div class="main-content">
            <div class="tree-container">
                <div class="tree">
                    <div class="tree-branches"></div>
                    <div class="tree-trunk"></div>
                </div>
            </div>
            
            <div class="controls">
                <button id="add-strength" aria-label="æ·»åŠ æ–°ä¼˜ç‚¹">æ·»åŠ ä¼˜ç‚¹</button>
                <button id="view-all" aria-label="æŸ¥çœ‹æ‰€æœ‰ä¼˜ç‚¹åˆ—è¡¨">æŸ¥çœ‹æ‰€æœ‰ä¼˜ç‚¹</button>
                <button id="achievements" aria-label="æŸ¥çœ‹æˆå°±ç³»ç»Ÿ">æˆå°±ç³»ç»Ÿ</button>
            </div>
        </div>
    </div>
    
    <div id="add-modal" class="modal" role="dialog" aria-labelledby="modal-title">
        <div class="modal-content">
            <h2 id="modal-title">è®°å½•æ–°ä¼˜ç‚¹</h2>
            <div class="form-group">
                <label for="strength-name">ä¼˜ç‚¹åç§°:</label>
                <input type="text" id="strength-name" placeholder="ä¾‹å¦‚ï¼šè€å¿ƒã€åŠ©äººä¸ºä¹ã€å‹‡æ•¢...">
            </div>
            
            <div class="form-group">
                <label for="strength-description">æè¿°è¿™ä¸ªä¼˜ç‚¹ (å…·ä½“äº‹ä¾‹):</label>
                <textarea id="strength-description" rows="4" placeholder="æè¿°å­©å­æ˜¯å¦‚ä½•å±•ç°è¿™ä¸ªä¼˜ç‚¹çš„..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="strength-category">åˆ†ç±»:</label>
                <select id="strength-category">
                    <option value="social">ç¤¾äº¤èƒ½åŠ›</option>
                    <option value="academic">å­¦ä¹ èƒ½åŠ›</option>
                    <option value="emotional">æƒ…æ„Ÿç®¡ç†</option>
                    <option value="creative">åˆ›é€ åŠ›</option>
                    <option value="physical">ä½“èƒ½è¡¨ç°</option>
                    <option value="character">å“æ ¼ç‰¹è´¨</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="strength-date">æ—¥æœŸ:</label>
                <input type="date" id="strength-date">
            </div>
            
            <div class="btn-group">
                <button id="cancel-add">å–æ¶ˆ</button>
                <button id="save-strength">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <h2 id="detail-title">ä¼˜ç‚¹è¯¦æƒ…</h2>
            <p id="detail-description"></p>
            <p><strong>åˆ†ç±»:</strong> <span id="detail-category"></span></p>
            <p><strong>è®°å½•æ—¥æœŸ:</strong> <span id="detail-date"></span></p>
            <p><strong>è¿›æ­¥æ¬¡æ•°:</strong> <span id="detail-count"></span></p>
            
            <div class="btn-group">
                <button id="close-detail">å…³é—­</button>
                <button id="add-progress">è®°å½•æ–°è¿›æ­¥</button>
            </div>
        </div>
    </div>
    
    <div id="all-strengths-modal" class="modal">
        <div class="modal-content">
            <h2>æ‰€æœ‰ä¼˜ç‚¹</h2>
            <div id="strengths-list">
                <!-- åŠ¨æ€ç”Ÿæˆä¼˜ç‚¹åˆ—è¡¨ -->
            </div>
            
            <div class="btn-group">
                <button id="close-all">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div id="achievement-banner" class="achievement-banner">
        <h3>ğŸ‰ æ–°æˆå°±è§£é”! ğŸ‰</h3>
        <p id="achievement-text"></p>
    </div>
    
    <script>
        // åˆå§‹åŒ–æ•°æ®
        let strengths = [];
        let achievements = [];
        
        try {
            strengths = JSON.parse(localStorage.getItem('strengths')) || [];
            achievements = JSON.parse(localStorage.getItem('achievements')) || [];
        } catch (error) {
            console.error('Error loading data from localStorage:', error);
            // å¦‚æœæ•°æ®æŸåï¼Œé‡ç½®ä¸ºç©ºæ•°ç»„
            localStorage.setItem('strengths', '[]');
            localStorage.setItem('achievements', '[]');
        }
        
        // é¢œè‰²æ˜ å°„è¡¨ - æ¯ä¸ªåˆ†ç±»å¯¹åº”ä¸åŒé¢œè‰²
        const categoryColors = {
            'social': '#FF7F50', // çŠç‘šè‰²
            'academic': '#9370DB', // ç´«è‰²
            'emotional': '#FF69B4', // ç²‰è‰²
            'creative': '#FFD700', // é‡‘è‰²
            'physical': '#32CD32', // ç»¿è‰²
            'character': '#1E90FF' // è“è‰²
        };
        
        // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé»˜è®¤æ—¥æœŸ
        document.getElementById('strength-date').valueAsDate = new Date();
        
        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ä¼˜åŒ–çš„ä¿å­˜å‡½æ•°
        const saveToLocalStorage = debounce((key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`Error saving ${key} to localStorage:`, error);
                alert('ä¿å­˜æ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }, 1000);
        
        // åˆ›å»ºSVGæ ‘ç»“æ„
        function createTree() {
            try {
                const treeSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                treeSvg.setAttribute('width', '100%');
                treeSvg.setAttribute('height', '100%');
                treeSvg.setAttribute('viewBox', '0 0 400 500');
                treeSvg.classList.add('tree-svg');
                
                // åˆ›å»ºæ ‘å¹²æ¸å˜
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                
                // æ ‘å¹²æ¸å˜
                const trunkGradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                trunkGradient.setAttribute('id', 'trunkGradient');
                trunkGradient.setAttribute('gradientTransform', 'rotate(90)');
                
                const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop1.setAttribute('offset', '0%');
                stop1.setAttribute('stop-color', '#6D4C41');
                
                const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop2.setAttribute('offset', '100%');
                stop2.setAttribute('stop-color', '#8D6E63');
                
                trunkGradient.appendChild(stop1);
                trunkGradient.appendChild(stop2);
                defs.appendChild(trunkGradient);
                
                // å¶å­å‘å…‰æ»¤é•œ
                const glowFilter = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
                glowFilter.setAttribute('id', 'leafGlow');
                glowFilter.setAttribute('x', '-50%');
                glowFilter.setAttribute('y', '-50%');
                glowFilter.setAttribute('width', '200%');
                glowFilter.setAttribute('height', '200%');
                
                const feGaussianBlur = document.createElementNS('http://www.w3.org/2000/svg', 'feGaussianBlur');
                feGaussianBlur.setAttribute('stdDeviation', '2');
                feGaussianBlur.setAttribute('result', 'blur');
                glowFilter.appendChild(feGaussianBlur);
                
                const feComposite = document.createElementNS('http://www.w3.org/2000/svg', 'feComposite');
                feComposite.setAttribute('in', 'SourceGraphic');
                feComposite.setAttribute('in2', 'blur');
                feComposite.setAttribute('operator', 'over');
                glowFilter.appendChild(feComposite);
                
                defs.appendChild(glowFilter);
                
                // åˆ›å»ºåœ°é¢/åœŸå£¤
                const ground = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                ground.setAttribute('d', 'M50,500 C100,480 300,480 350,500 L350,500 L50,500 Z');
                ground.setAttribute('fill', '#3E2723');
                ground.setAttribute('opacity', '0.7');
                
                // åˆ›å»ºæ›´è‡ªç„¶çš„æ ‘å¹²
                const trunk = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                trunk.setAttribute('d', `
                    M200,500 
                    C195,450 190,400 195,350 
                    C200,300 195,250 200,200 
                    C205,250 200,300 205,350 
                    C210,400 205,450 200,500 
                    M193,450 
                    C188,430 185,410 188,390 
                    M207,450 
                    C212,430 215,410 212,390
                `);
                trunk.setAttribute('fill', 'url(#trunkGradient)');
                trunk.classList.add('svg-trunk');
                
                // æ·»åŠ ä¸»è¦åˆ†æ”¯ - æ›´æœ‰æœºçš„å¼¯æ›²å½¢çŠ¶
                const branches = [];
                
                // å·¦ä¾§ä¸»åˆ†æ”¯
                branches.push(createBranch('M195,340 C170,320 140,310 110,320 C90,325 70,330 60,310', 5));
                branches.push(createBranch('M192,290 C160,285 130,270 115,240 C105,220 95,205 75,210', 4));
                branches.push(createBranch('M190,240 C170,220 155,190 160,160 C165,140 155,120 135,115', 4));
                
                // å³ä¾§ä¸»åˆ†æ”¯
                branches.push(createBranch('M205,340 C230,320 260,310 290,320 C310,325 330,330 340,310', 5));
                branches.push(createBranch('M208,290 C240,285 270,270 285,240 C295,220 305,205 325,210', 4));
                branches.push(createBranch('M210,240 C230,220 245,190 240,160 C235,140 245,120 265,115', 4));
                
                // é¡¶éƒ¨åˆ†æ”¯
                branches.push(createBranch('M200,200 C190,180 185,160 200,140 C210,120 200,100 190,80', 4));
                branches.push(createBranch('M200,140 C210,120 215,100 210,80', 3));
                
                // å°æ ‘æ - å¢åŠ æ›´å¤šç»†èŠ‚
                const twigs = [];
                
                // å·¦ä¾§å°æ
                twigs.push(createTwig('M135,115 C125,105 115,100 105,105 C95,110 85,105 80,95', 1.5));
                twigs.push(createTwig('M105,175 C95,170 85,165 80,155 C75,145 65,140 60,145', 1.5));
                twigs.push(createTwig('M75,210 C65,205 55,210 50,200 C45,190 35,195 30,185', 1.5));
                twigs.push(createTwig('M95,260 C85,250 75,255 65,250 C55,245 45,250 40,240', 1.5));
                twigs.push(createTwig('M60,310 C50,305 45,295 35,300 C25,305 20,295 15,300', 1.5));
                
                // å³ä¾§å°æ
                twigs.push(createTwig('M265,115 C275,105 285,100 295,105 C305,110 315,105 320,95', 1.5));
                twigs.push(createTwig('M295,175 C305,170 315,165 320,155 C325,145 335,140 340,145', 1.5));
                twigs.push(createTwig('M325,210 C335,205 345,210 350,200 C355,190 365,195 370,185', 1.5));
                twigs.push(createTwig('M305,260 C315,250 325,255 335,250 C345,245 355,250 360,240', 1.5));
                twigs.push(createTwig('M340,310 C350,305 355,295 365,300 C375,305 380,295 385,300', 1.5));
                
                // é¡¶éƒ¨å°æ
                twigs.push(createTwig('M190,80 C180,70 175,60 185,50 C195,40 190,30 180,25', 1.5));
                twigs.push(createTwig('M210,80 C220,70 225,60 215,50 C205,40 210,30 220,25', 1.5));
                
                // æ·»åŠ æ›´å¤šè£…é¥°æ€§çš„å°ææ¡
                twigs.push(createTwig('M150,200 C140,195 135,185 145,175', 1));
                twigs.push(createTwig('M250,200 C260,195 265,185 255,175', 1));
                twigs.push(createTwig('M170,280 C160,275 155,265 165,255', 1));
                twigs.push(createTwig('M230,280 C240,275 245,265 235,255', 1));
                
                // æ·»åŠ æ¨¡æ‹Ÿæ ‘å¶åŒºåŸŸ - æ›´è‡ªç„¶çš„åˆ†å¸ƒ
                const foliageGroups = [
                    { cx: 200, cy: 90, rx: 110, ry: 85 },      // é¡¶éƒ¨ä¸­å¤®
                    { cx: 145, cy: 130, rx: 75, ry: 60 },      // å·¦ä¸Š
                    { cx: 255, cy: 130, rx: 75, ry: 60 },      // å³ä¸Š
                    { cx: 110, cy: 190, rx: 65, ry: 50 },      // å·¦ä¸­ä¸Š
                    { cx: 290, cy: 190, rx: 65, ry: 50 },      // å³ä¸­ä¸Š
                    { cx: 85, cy: 260, rx: 65, ry: 50 },       // å·¦ä¸­ä¸‹
                    { cx: 315, cy: 260, rx: 65, ry: 50 },      // å³ä¸­ä¸‹
                    { cx: 80, cy: 320, rx: 60, ry: 45 },       // å·¦ä¸‹
                    { cx: 320, cy: 320, rx: 60, ry: 45 },      // å³ä¸‹
                    { cx: 170, cy: 160, rx: 45, ry: 35 },      // å·¦ä¸­å¡«å……
                    { cx: 230, cy: 160, rx: 45, ry: 35 },      // å³ä¸­å¡«å……
                    { cx: 200, cy: 220, rx: 40, ry: 30 }       // ä¸­å¤®å¡«å……
                ];
                
                // å°†æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°SVG
                treeSvg.appendChild(defs);
                treeSvg.appendChild(ground);
                treeSvg.appendChild(trunk);
                
                // æ·»åŠ åˆ†æ”¯
                branches.forEach(branch => treeSvg.appendChild(branch));
                
                // æ·»åŠ å°æ ‘æ
                twigs.forEach(twig => treeSvg.appendChild(twig));
                
                // æ·»åŠ æ ‘å¶åŒºåŸŸ
                const foliageFragment = document.createDocumentFragment();
                foliageGroups.forEach((ellipse, index) => {
                    const foliage = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                    Object.entries(ellipse).forEach(([attr, value]) => {
                        foliage.setAttribute(attr, value);
                    });
                    foliage.setAttribute('fill', 'rgba(10, 77, 46, 0.1)');
                    foliage.setAttribute('data-area', `area-${index}`);
                    foliage.classList.add('foliage-area');
                    foliageFragment.appendChild(foliage);
                });
                treeSvg.appendChild(foliageFragment);
                
                return treeSvg;
            } catch (error) {
                console.error('Error creating tree:', error);
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„é”™è¯¯æç¤º
                const errorElement = document.createElement('div');
                errorElement.textContent = 'åˆ›å»ºæ ‘æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                errorElement.style.color = 'red';
                return errorElement;
            }
        }

        // åˆ›å»ºåˆ†æ”¯è¾…åŠ©å‡½æ•° - ä½¿ç”¨æ›´è‡ªç„¶çš„çº¿æ¡æ ·å¼
        function createBranch(pathD, width) {
            const branch = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            branch.setAttribute('d', pathD);
            branch.setAttribute('stroke', '#5D4037');
            branch.setAttribute('stroke-width', width);
            branch.setAttribute('fill', 'none');
            branch.setAttribute('stroke-linecap', 'round');
            branch.classList.add('tree-branch');
            return branch;
        }

        // åˆ›å»ºå°æ ‘æè¾…åŠ©å‡½æ•° - æ›´ç»†çš„çº¿æ¡
        function createTwig(pathD, width) {
            const twig = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            twig.setAttribute('d', pathD);
            twig.setAttribute('stroke', '#6D4C41');
            twig.setAttribute('stroke-width', width);
            twig.setAttribute('fill', 'none');
            twig.setAttribute('stroke-linecap', 'round');
            twig.classList.add('tree-twig');
            return twig;
        }

        // æ›´æ–°å¶å­æ ·å¼ - æ›´è‡ªç„¶çš„å½¢çŠ¶
        function generateLeafSVG(color, count) {
            return `
                <svg width="40" height="40" viewBox="0 0 100 100">
                    <path d="M50,10 C65,25 90,25 90,50 C90,75 65,85 50,90 C35,85 10,75 10,50 C10,25 35,25 50,10 Z" 
                          fill="${color}" 
                          filter="url(#leafGlow)" />
                    <text x="50" y="55" text-anchor="middle" fill="white" font-size="16" font-weight="bold">${count}</text>
                </svg>
            `;
        }

        // ä¼˜åŒ–ç”Ÿç‰©å‘å…‰æ•ˆæœ - æ›´è‡ªç„¶çš„åˆ†å¸ƒå’ŒåŠ¨ç”»
        function addBioLuminescence() {
            try {
                const treeElement = document.querySelector('.tree');
                if (!treeElement) {
                    console.error('Tree element not found');
                    return;
                }
                
                const treeRect = treeElement.getBoundingClientRect();
                const fragment = document.createDocumentFragment();
                
                // è·å–æ‰€æœ‰æ ‘å¶åŒºåŸŸ
                const foliageAreas = document.querySelectorAll('.foliage-area');
                
                // ä¸ºæ¯ä¸ªåŒºåŸŸæ·»åŠ å‘å…‰ç‚¹
                foliageAreas.forEach(area => {
                    const bbox = area.getBBox();
                    
                    // ä¸ºæ¯ä¸ªåŒºåŸŸç”Ÿæˆ10-15ä¸ªå‘å…‰ç‚¹
                    const numLights = 10 + Math.floor(Math.random() * 6);
                    
                    for (let i = 0; i < numLights; i++) {
                        const light = document.createElement('div');
                        light.classList.add('bio-luminescence');
                        
                        // åœ¨æ¤­åœ†åŒºåŸŸå†…éšæœºæ”¾ç½®
                        const angle = Math.random() * Math.PI * 2;
                        const radiusX = (Math.random() * 0.8 + 0.2) * bbox.width / 2;
                        const radiusY = (Math.random() * 0.8 + 0.2) * bbox.height / 2;
                        
                        const x = Math.cos(angle) * radiusX + bbox.x + bbox.width/2;
                        const y = Math.sin(angle) * radiusY + bbox.y + bbox.height/2;
                        
                        // è®¡ç®—ç›¸å¯¹äºè§†å›¾åŒºåŸŸçš„ç™¾åˆ†æ¯”ä½ç½®
                        const percentX = (x / 400) * 100;
                        const percentY = (y / 500) * 100;
                        
                        const size = 2 + Math.random() * 3;
                        
                        Object.assign(light.style, {
                            left: `${percentX}%`,
                            top: `${percentY}%`,
                            width: `${size}px`,
                            height: `${size}px`,
                            animationDelay: `${Math.random() * 5}s`,
                            animationDuration: `${2 + Math.random() * 3}s`
                        });
                        
                        fragment.appendChild(light);
                    }
                });
                
                treeElement.appendChild(fragment);
            } catch (error) {
                console.error('Error adding bio-luminescence:', error);
            }
        }

        // æ›´æ–°å¶å­ç”Ÿæˆå‡½æ•° - ä½¿ç”¨æ›´è‡ªç„¶çš„å¶å­å½¢çŠ¶
        function addLeafToTree(strength, index) {
            try {
                const leaf = document.createElement('div');
                leaf.classList.add('leaf');
                leaf.dataset.index = index;
                
                // ç”ŸæˆSVGå¶å­
                const color = categoryColors[strength.category] || '#FFFFFF';
                leaf.innerHTML = generateLeafSVG(color, strength.count);
                
                // æ ¹æ®åˆ†ç±»é€‰æ‹©æ”¾ç½®åŒºåŸŸ
                let areaIndex;
                switch(strength.category) {
                    case 'social': areaIndex = 1; break;      // å·¦ä¸Š
                    case 'academic': areaIndex = 2; break;    // å³ä¸Š
                    case 'emotional': areaIndex = 0; break;   // é¡¶éƒ¨
                    case 'creative': areaIndex = 3; break;    // å·¦ä¸­ä¸Š
                    case 'physical': areaIndex = 4; break;    // å³ä¸­ä¸Š
                    case 'character': areaIndex = 0; break;   // é¡¶éƒ¨
                    default: areaIndex = Math.floor(Math.random() * 9);
                }
                
                const foliageArea = document.querySelector(`[data-area="area-${areaIndex}"]`);
                if (!foliageArea) {
                    placeLeafRandomly(leaf);
                    return;
                }
                
                // è·å–è¯¥åŒºåŸŸçš„ä½ç½®å’Œå¤§å°
                const bbox = foliageArea.getBBox();
                
                // åœ¨æ¤­åœ†åŒºåŸŸå†…éšæœºæ”¾ç½® - æ›´è‡ªç„¶çš„åˆ†å¸ƒ
                const angle = Math.random() * Math.PI * 2;
                const radiusX = (Math.random() * 0.8 + 0.2) * bbox.width / 2;
                const radiusY = (Math.random() * 0.8 + 0.2) * bbox.height / 2;
                
                const x = Math.cos(angle) * radiusX + bbox.x + bbox.width/2;
                const y = Math.sin(angle) * radiusY + bbox.y + bbox.height/2;
                
                // è®¡ç®—ç›¸å¯¹äºè§†å›¾åŒºåŸŸçš„ç™¾åˆ†æ¯”ä½ç½®
                const percentX = (x / 400) * 100;
                const percentY = (y / 500) * 100;
                
                leaf.style.left = `${percentX}%`;
                leaf.style.top = `${percentY}%`;
                
                // éšæœºæ—‹è½¬ - æ›´è‡ªç„¶çš„è§’åº¦
                const rotation = -20 + Math.random() * 40; // -20åˆ°20åº¦ä¹‹é—´çš„è§’åº¦
                leaf.style.transform = `rotate(${rotation}deg)`;
                
                // æ ¹æ®è®¡æ•°è°ƒæ•´å¤§å°
                const scale = 0.8 + Math.min(strength.count * 0.05, 0.8); // æœ€å¤§æ”¾å¤§åˆ°1.6å€
                leaf.style.setProperty('--leaf-scale', scale);
                
                // ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºè¯¦æƒ…
                leaf.addEventListener('click', () => showStrengthDetails(index));
                
                document.querySelector('.tree').appendChild(leaf);
            } catch (error) {
                console.error('Error adding leaf to tree:', error);
                // å¦‚æœå‡ºé”™ï¼Œå°è¯•ä½¿ç”¨éšæœºæ”¾ç½®ä½œä¸ºåå¤‡æ–¹æ¡ˆ
                try {
                    placeLeafRandomly(leaf);
                } catch (fallbackError) {
                    console.error('Fallback placement failed:', fallbackError);
                }
            }
        }

        // éšæœºæ”¾ç½®å¶å­
        function placeLeafRandomly(leaf) {
            const treeElement = document.querySelector('.tree');
            const treeRect = treeElement.getBoundingClientRect();
            
            const centerX = treeRect.width / 2;
            const centerY = treeRect.height / 2 - 50;
            
            const radius = Math.min(treeRect.width, treeRect.height) * 0.4;
            const angle = Math.random() * Math.PI * 2;
            const distance = Math.random() * radius;
            
            const x = Math.cos(angle) * distance + centerX - 20;
            const y = Math.sin(angle) * distance + centerY - 20;
            
            leaf.style.left = `${x}px`;
            leaf.style.top = `${y}px`;
        }

        // æ˜¾ç¤ºä¼˜ç‚¹è¯¦æƒ…
        function showStrengthDetails(index) {
            const strength = strengths[index];
            
            document.getElementById('detail-title').textContent = strength.name;
            document.getElementById('detail-description').textContent = strength.description;
            document.getElementById('detail-category').textContent = getCategoryName(strength.category);
            document.getElementById('detail-date').textContent = strength.date;
            document.getElementById('detail-count').textContent = strength.count;
            
            // ä¿å­˜å½“å‰æŸ¥çœ‹çš„ä¼˜ç‚¹ç´¢å¼•
            document.getElementById('add-progress').dataset.index = index;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('detail-modal').style.display = 'flex';
        }
        
        // è·å–åˆ†ç±»çš„ä¸­æ–‡åç§°
        function getCategoryName(category) {
            const categoryNames = {
                'social': 'ç¤¾äº¤èƒ½åŠ›',
                'academic': 'å­¦ä¹ èƒ½åŠ›',
                'emotional': 'æƒ…æ„Ÿç®¡ç†',
                'creative': 'åˆ›é€ åŠ›',
                'physical': 'ä½“èƒ½è¡¨ç°',
                'character': 'å“æ ¼ç‰¹è´¨'
            };
            
            return categoryNames[category] || category;
        }
        
        // æ·»åŠ ä¼˜ç‚¹
        document.getElementById('add-strength').addEventListener('click', () => {
            document.getElementById('add-modal').style.display = 'flex';
        });
        
        // ä¿å­˜ä¼˜ç‚¹
        document.getElementById('save-strength').addEventListener('click', async () => {
            const name = document.getElementById('strength-name').value.trim();
            const description = document.getElementById('strength-description').value.trim();
            const category = document.getElementById('strength-category').value;
            const date = document.getElementById('strength-date').value;
            
            if (!name || !description) {
                alert('è¯·å¡«å†™ä¼˜ç‚¹åç§°å’Œæè¿°');
                return;
            }
            
            // åˆ›å»ºæ–°ä¼˜ç‚¹
            const newStrength = {
                name,
                description,
                category,
                date,
                count: 1,
                progress: [{
                    description,
                    date
                }]
            };
            
            // æ·»åŠ åˆ°æ•°ç»„
            strengths.push(newStrength);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage('strengths', strengths);
            
            // å…³é—­æ¨¡æ€æ¡†å¹¶æ¸…ç©ºè¡¨å•
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('strength-name').value = '';
            document.getElementById('strength-description').value = '';
            document.getElementById('strength-date').valueAsDate = new Date();
            
            // æ·»åŠ æ ‘ç”Ÿé•¿åŠ¨ç”»
            const treeSvg = document.querySelector('.tree-svg');
            treeSvg.classList.add('tree-pulse');
            
            // åˆ›å»ºå¹¶æ·»åŠ æ–°å¶å­
            const leaf = document.createElement('div');
            leaf.classList.add('leaf');
            leaf.dataset.index = strengths.length - 1;
            
            // è®¾ç½®éšæœºåˆå§‹æ—‹è½¬è§’åº¦
            const initialRotation = Math.random() * 360;
            leaf.style.setProperty('--initial-rotation', `${initialRotation}deg`);
            
            // å»¶è¿Ÿæ·»åŠ å¶å­ï¼Œé…åˆæ ‘ç”Ÿé•¿åŠ¨ç”»
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æ·»åŠ å¶å­åˆ°æ ‘ä¸Š
            addLeafToTree(newStrength, strengths.length - 1);
            
            // è·å–æ–°æ·»åŠ çš„å¶å­å¹¶æ·»åŠ å‡ºç°åŠ¨ç”»
            const newLeaf = document.querySelector(`.leaf[data-index="${strengths.length - 1}"]`);
            newLeaf.classList.add('leaf-appear');
            
            // ç§»é™¤æ ‘ç”Ÿé•¿åŠ¨ç”»
            setTimeout(() => {
                treeSvg.classList.remove('tree-pulse');
                newLeaf.classList.remove('leaf-appear');
            }, 1500);
            
            // æ£€æŸ¥æˆå°±
            checkAchievements(strengths.length, category);
        });
        
        // è®°å½•æ–°è¿›æ­¥
        document.getElementById('add-progress').addEventListener('click', async () => {
            const index = parseInt(document.getElementById('add-progress').dataset.index);
            
            // æç¤ºç”¨æˆ·è¾“å…¥æ–°è¿›æ­¥
            const progressDescription = prompt('è¯·æè¿°è¿™æ¬¡çš„è¿›æ­¥:');
            
            if (progressDescription && progressDescription.trim()) {
                // æ›´æ–°ä¼˜ç‚¹
                strengths[index].count++;
                strengths[index].progress.push({
                    description: progressDescription.trim(),
                    date: new Date().toISOString().split('T')[0]
                });
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveToLocalStorage('strengths', strengths);
                
                // æ›´æ–°è¯¦æƒ…æ˜¾ç¤º
                document.getElementById('detail-count').textContent = strengths[index].count;
                
                // è·å–å¶å­å…ƒç´ 
                const leafElement = document.querySelector(`.leaf[data-index="${index}"]`);
                
                // ä¿å­˜å½“å‰æ—‹è½¬è§’åº¦
                const currentTransform = getComputedStyle(leafElement).transform;
                const currentRotation = currentTransform !== 'none' 
                    ? Math.atan2(currentTransform.split(', ')[1], currentTransform.split(', ')[0]) * (180/Math.PI)
                    : 0;
                
                leafElement.style.setProperty('--initial-rotation', `${currentRotation}deg`);
                
                // æ·»åŠ è¿›æ­¥åŠ¨ç”»
                leafElement.classList.add('leaf-progress');
                
                // æ›´æ–°å¶å­ä¸Šçš„è®¡æ•°ï¼ˆåœ¨åŠ¨ç”»ä¸­é—´ç‚¹ï¼‰
                setTimeout(() => {
                    leafElement.querySelector('text').textContent = strengths[index].count;
                }, 1000);
                
                // æ·»åŠ æ ‘ç”Ÿé•¿åŠ¨ç”»
                const treeSvg = document.querySelector('.tree-svg');
                treeSvg.classList.add('tree-pulse');
                
                // ç§»é™¤åŠ¨ç”»ç±»
                setTimeout(() => {
                    leafElement.classList.remove('leaf-progress');
                    treeSvg.classList.remove('tree-pulse');
                }, 2000);
                
                // æ£€æŸ¥æˆå°±
                checkAchievements(0, strengths[index].category, strengths[index].count);
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('detail-modal').style.display = 'none';
            }
        });
        
        // æŸ¥çœ‹æ‰€æœ‰ä¼˜ç‚¹
        document.getElementById('view-all').addEventListener('click', () => {
            const listElement = document.getElementById('strengths-list');
            listElement.innerHTML = '';
            
            if (strengths.length === 0) {
                listElement.innerHTML = '<p>è¿˜æ²¡æœ‰è®°å½•ä¼˜ç‚¹ï¼Œç‚¹å‡»"æ·»åŠ ä¼˜ç‚¹"å¼€å§‹è®°å½•å§ï¼</p>';
            } else {
                const categories = {};
                
                // æŒ‰åˆ†ç±»åˆ†ç»„
                strengths.forEach((strength, index) => {
                    if (!categories[strength.category]) {
                        categories[strength.category] = [];
                    }
                    categories[strength.category].push({...strength, index});
                });
                
                // éå†åˆ†ç±»åˆ›å»ºåˆ—è¡¨
                for (const category in categories) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<h3 style="color: ${categoryColors[category]}">${getCategoryName(category)}</h3>`;
                    
                    const strengthsList = document.createElement('ul');
                    categories[category].forEach(strength => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <a href="#" data-index="${strength.index}">${strength.name} (è¿›æ­¥æ¬¡æ•°: ${strength.count})</a>
                        `;
                        listItem.querySelector('a').addEventListener('click', (e) => {
                            e.preventDefault();
                            document.getElementById('all-strengths-modal').style.display = 'none';
                            showStrengthDetails(strength.index);
                        });
                        strengthsList.appendChild(listItem);
                    });
                    
                    categoryDiv.appendChild(strengthsList);
                    listElement.appendChild(categoryDiv);
                }
            }
            
            document.getElementById('all-strengths-modal').style.display = 'flex';
        });
        
        // æ£€æŸ¥æˆå°±
        function checkAchievements(totalStrengths, category, count) {
            let newAchievement = null;
            
            // æ•°é‡æˆå°±
            if (totalStrengths === 1 && !hasAchievement('first_strength')) {
                newAchievement = {
                    id: 'first_strength',
                    name: 'ç¬¬ä¸€æ¬¡å‘ç°',
                    description: 'è®°å½•äº†ç¬¬ä¸€ä¸ªä¼˜ç‚¹ï¼ç»§ç»­æ¢ç´¢æ›´å¤šå§ï¼'
                };
            } else if (totalStrengths === 5 && !hasAchievement('five_strengths')) {
                newAchievement = {
                    id: 'five_strengths',
                    name: 'å…‰èŠ’åˆç°',
                    description: 'å·²ç»å‘ç°äº†5ä¸ªä¼˜ç‚¹ï¼å­©å­æ­£åœ¨èŒå£®æˆé•¿ï¼'
                };
            } else if (totalStrengths === 10 && !hasAchievement('ten_strengths')) {
                newAchievement = {
                    id: 'ten_strengths',
                    name: 'é—ªè€€ä¹‹æ ‘',
                    description: 'å‘ç°äº†10ä¸ªä¼˜ç‚¹ï¼è¿™æ£µæ ‘çœŸæ˜¯å…‰å½©å¤ºç›®ï¼'
                };
            }
            
            // åˆ†ç±»æˆå°±
            if (category) {
                const categoryStrengths = strengths.filter(s => s.category === category).length;
                if (categoryStrengths === 3 && !hasAchievement(`${category}_expert`)) {
                    const categoryNames = {
                        'social': 'ç¤¾äº¤è¾¾äºº',
                        'academic': 'å­¦ä¹ èƒ½æ‰‹',
                        'emotional': 'æƒ…ç»ªç®¡ç†å¸ˆ',
                        'creative': 'åˆ›é€ å¤©æ‰',
                        'physical': 'è¿åŠ¨å¥å°†',
                        'character': 'å“æ ¼æ¥·æ¨¡'
                    };
                    
                    newAchievement = {
                        id: `${category}_expert`,
                        name: categoryNames[category],
                        description: `åœ¨${getCategoryName(category)}æ–¹é¢å‘ç°äº†3ä¸ªä¼˜ç‚¹ï¼`
                    };
                }
            }
            
            // è¿›æ­¥æ¬¡æ•°æˆå°±
            if (count === 5 && !hasAchievement('five_progress')) {
                newAchievement = {
                    id: 'five_progress',
                    name: 'æŒç»­è¿›æ­¥',
                    description: 'åœ¨ä¸€ä¸ªä¼˜ç‚¹ä¸Šå–å¾—äº†5æ¬¡è¿›æ­¥ï¼åšæŒçš„åŠ›é‡çœŸä¼Ÿå¤§ï¼'
                };
            } else if (count === 10 && !hasAchievement('ten_progress')) {
                newAchievement = {
                    id: 'ten_progress',
                    name: 'ç²¾ç›Šæ±‚ç²¾',
                    description: 'åœ¨ä¸€ä¸ªä¼˜ç‚¹ä¸Šå–å¾—äº†10æ¬¡è¿›æ­¥ï¼è¿™å·²ç»æˆä¸ºä¸€ç§ä¼˜ç§€çš„ä¹ æƒ¯ï¼'
                };
            }
            
            // å¦‚æœè·å¾—æ–°æˆå°±
            if (newAchievement) {
                achievements.push(newAchievement);
                saveToLocalStorage('achievements', achievements);
                showAchievementBanner(newAchievement);
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æˆå°±
        function hasAchievement(id) {
            return achievements.some(a => a.id === id);
        }
        
        // æ˜¾ç¤ºæˆå°±æ¨ªå¹…
        function showAchievementBanner(achievement) {
            const banner = document.getElementById('achievement-banner');
            document.getElementById('achievement-text').textContent = achievement.name + ' - ' + achievement.description;
            
            banner.style.display = 'block';
            
            // 5ç§’åéšè—
            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }
        
        // å…³é—­æŒ‰é’®
        document.getElementById('cancel-add').addEventListener('click', () => {
            document.getElementById('add-modal').style.display = 'none';
        });
        
        document.getElementById('close-detail').addEventListener('click', () => {
            document.getElementById('detail-modal').style.display = 'none';
        });
        
        document.getElementById('close-all').addEventListener('click', () => {
            document.getElementById('all-strengths-modal').style.display = 'none';
        });
        
        // æˆå°±ç³»ç»Ÿ
        document.getElementById('achievements').addEventListener('click', () => {
            const modal = document.createElement('div');
            modal.classList.add('modal');
            modal.style.display = 'flex';
            
            let content = `
                <div class="modal-content">
                    <h2>æˆå°±ç³»ç»Ÿ</h2>
            `;
            
            if (achievements.length === 0) {
                content += `<p>è¿˜æ²¡æœ‰è§£é”ä»»ä½•æˆå°±ã€‚ç»§ç»­è®°å½•å­©å­çš„ä¼˜ç‚¹ï¼Œå¾ˆå¿«å°±ä¼šæœ‰æƒŠå–œï¼</p>`;
            } else {
                content += `<ul>`;
                achievements.forEach(achievement => {
                    content += `<li><strong>${achievement.name}</strong> - ${achievement.description}</li>`;
                });
                content += `</ul>`;
            }
            
            content += `
                    <div class="btn-group">
                        <button id="close-achievements">å…³é—­</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
            
            document.getElementById('close-achievements').addEventListener('click', () => {
                modal.remove();
            });
        });
        
        // åˆå§‹åŒ–æ ‘
        function initTree() {
            try {
                // è·å–æ ‘å®¹å™¨
                const treeContainer = document.querySelector('.tree');
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                while (treeContainer.firstChild) {
                    treeContainer.removeChild(treeContainer.firstChild);
                }
                
                // åˆ›å»ºæ ‘çš„SVGç»“æ„
                const treeSvg = createTree();
                treeContainer.appendChild(treeSvg);
                
                // æ·»åŠ ç”Ÿç‰©å‘å…‰æ•ˆæœ
                addBioLuminescence();
                
                // æ·»åŠ ç°æœ‰çš„å¶å­
                strengths.forEach((strength, index) => {
                    addLeafToTree(strength, index);
                });
            } catch (error) {
                console.error('Error initializing tree:', error);
                alert('åˆå§‹åŒ–æ ‘æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', () => {
            initTree();
        });
    </script>
</body>
</html>
