<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜ç‚¹æ ‘ - å‘ç°å­©å­çš„é—ªå…‰ç‚¹</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¼˜ç‚¹æ ‘</h1>
        </header>
        
        <div class="main-content">
            <div class="tree-container">
                <div class="tree">
                    <img src="image/tree.png" alt="æ ‘çš„èƒŒæ™¯" class="tree-background">
                    <div class="leaves-container"></div>
                </div>
            </div>
            
            <div class="controls">
                <button id="add-strength" aria-label="æ·»åŠ æ–°ä¼˜ç‚¹">æ·»åŠ ä¼˜ç‚¹</button>
                <button id="view-all" aria-label="æŸ¥çœ‹æ‰€æœ‰ä¼˜ç‚¹åˆ—è¡¨">æŸ¥çœ‹æ‰€æœ‰ä¼˜ç‚¹</button>
                <button id="achievements" aria-label="æŸ¥çœ‹æˆå°±ç³»ç»Ÿ">æˆå°±ç³»ç»Ÿ</button>
            </div>
        </div>
    </div>
    
    <div id="add-modal" class="modal" role="dialog" aria-labelledby="modal-title">
        <div class="modal-content">
            <h2 id="modal-title">è®°å½•æ–°ä¼˜ç‚¹</h2>
            <div class="form-group">
                <label for="strength-name">ä¼˜ç‚¹åç§°:</label>
                <input type="text" id="strength-name" placeholder="ä¾‹å¦‚ï¼šè€å¿ƒã€åŠ©äººä¸ºä¹ã€å‹‡æ•¢...">
            </div>
            
            <div class="form-group">
                <label for="strength-description">æè¿°è¿™ä¸ªä¼˜ç‚¹ (å…·ä½“äº‹ä¾‹):</label>
                <textarea id="strength-description" rows="4" placeholder="æè¿°å­©å­æ˜¯å¦‚ä½•å±•ç°è¿™ä¸ªä¼˜ç‚¹çš„..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="strength-category">åˆ†ç±»:</label>
                <select id="strength-category">
                    <option value="social">ç¤¾äº¤èƒ½åŠ›</option>
                    <option value="academic">å­¦ä¹ èƒ½åŠ›</option>
                    <option value="emotional">æƒ…æ„Ÿç®¡ç†</option>
                    <option value="creative">åˆ›é€ åŠ›</option>
                    <option value="physical">ä½“èƒ½è¡¨ç°</option>
                    <option value="character">å“æ ¼ç‰¹è´¨</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="strength-date">æ—¥æœŸ:</label>
                <input type="date" id="strength-date">
            </div>
            
            <div class="btn-group">
                <button id="cancel-add">å–æ¶ˆ</button>
                <button id="save-strength">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <h2 id="detail-title">ä¼˜ç‚¹è¯¦æƒ…</h2>
            <p id="detail-description"></p>
            <p><strong>åˆ†ç±»:</strong> <span id="detail-category"></span></p>
            <p><strong>è®°å½•æ—¥æœŸ:</strong> <span id="detail-date"></span></p>
            <p><strong>è¿›æ­¥æ¬¡æ•°:</strong> <span id="detail-count"></span></p>
            
            <div class="btn-group">
                <button id="close-detail">å…³é—­</button>
                <button id="add-progress">è®°å½•æ–°è¿›æ­¥</button>
            </div>
        </div>
    </div>
    
    <div id="all-strengths-modal" class="modal">
        <div class="modal-content">
            <h2>æ‰€æœ‰ä¼˜ç‚¹</h2>
            <div id="strengths-list">
                <!-- åŠ¨æ€ç”Ÿæˆä¼˜ç‚¹åˆ—è¡¨ -->
            </div>
            
            <div class="btn-group">
                <button id="close-all">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div id="achievement-banner" class="achievement-banner">
        <h3>ğŸ‰ æ–°æˆå°±è§£é”! ğŸ‰</h3>
        <p id="achievement-text"></p>
    </div>
    
    <script>
        // åˆå§‹åŒ–æ•°æ®
        let strengths = [];
        let achievements = [];
        
        try {
            strengths = JSON.parse(localStorage.getItem('strengths')) || [];
            achievements = JSON.parse(localStorage.getItem('achievements')) || [];
        } catch (error) {
            console.error('Error loading data from localStorage:', error);
            // å¦‚æœæ•°æ®æŸåï¼Œé‡ç½®ä¸ºç©ºæ•°ç»„
            localStorage.setItem('strengths', '[]');
            localStorage.setItem('achievements', '[]');
        }
        
        // é¢œè‰²æ˜ å°„è¡¨ - æ¯ä¸ªåˆ†ç±»å¯¹åº”ä¸åŒé¢œè‰²
        const categoryColors = {
            'social': '#FF7F50', // çŠç‘šè‰²
            'academic': '#9370DB', // ç´«è‰²
            'emotional': '#FF69B4', // ç²‰è‰²
            'creative': '#FFD700', // é‡‘è‰²
            'physical': '#32CD32', // ç»¿è‰²
            'character': '#1E90FF' // è“è‰²
        };
        
        // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé»˜è®¤æ—¥æœŸ
        document.getElementById('strength-date').valueAsDate = new Date();
        
        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ä¼˜åŒ–çš„ä¿å­˜å‡½æ•°
        const saveToLocalStorage = debounce((key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`Error saving ${key} to localStorage:`, error);
                alert('ä¿å­˜æ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }, 1000);
        
        // å®šä¹‰å¶å­åŒºåŸŸ
        const leafAreas = [
            { id: 1, left: '20%', top: '20%', width: '25%', height: '25%' }, // å·¦ä¸Š
            { id: 2, left: '55%', top: '20%', width: '25%', height: '25%' }, // å³ä¸Š
            { id: 3, left: '35%', top: '35%', width: '30%', height: '30%' }, // ä¸­å¤®
            { id: 4, left: '15%', top: '40%', width: '25%', height: '25%' }, // å·¦ä¸­
            { id: 5, left: '60%', top: '40%', width: '25%', height: '25%' }  // å³ä¸­
        ];
        
        // åˆå§‹åŒ–æ ‘
        function initTree() {
            try {
                const treeContainer = document.querySelector('.tree');
                const leavesContainer = document.querySelector('.leaves-container');
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                leavesContainer.innerHTML = '';
                
                // åˆ›å»ºå¶å­åŒºåŸŸ
                leafAreas.forEach(area => {
                    const areaDiv = document.createElement('div');
                    areaDiv.classList.add('leaf-area', `leaf-area-${area.id}`);
                    leavesContainer.appendChild(areaDiv);
                });
                
                // æ·»åŠ ç°æœ‰çš„å¶å­
                strengths.forEach((strength, index) => {
                    addLeafToTree(strength, index);
                });
                
                // æ·»åŠ ç”Ÿç‰©å‘å…‰æ•ˆæœ
                addBioLuminescence();
                
            } catch (error) {
                console.error('Error initializing tree:', error);
                alert('åˆå§‹åŒ–æ ‘æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // æ·»åŠ å¶å­åˆ°æ ‘ä¸Š
        function addLeafToTree(strength, index) {
            try {
                const leaf = document.createElement('div');
                leaf.classList.add('leaf');
                leaf.dataset.index = index;
                
                // æ ¹æ®åˆ†ç±»é€‰æ‹©åŒºåŸŸ
                let areaIndex;
                switch(strength.category) {
                    case 'social': areaIndex = 0; break;      // å·¦ä¸Š
                    case 'academic': areaIndex = 1; break;    // å³ä¸Š
                    case 'emotional': areaIndex = 2; break;   // ä¸­å¤®
                    case 'creative': areaIndex = 3; break;    // å·¦ä¸­
                    case 'physical': areaIndex = 4; break;    // å³ä¸­
                    case 'character': areaIndex = Math.floor(Math.random() * 5); break;
                    default: areaIndex = Math.floor(Math.random() * 5);
                }
                
                const area = leafAreas[areaIndex];
                
                // åœ¨åŒºåŸŸå†…éšæœºä½ç½®
                const randomX = Math.random() * parseFloat(area.width);
                const randomY = Math.random() * parseFloat(area.height);
                
                leaf.style.left = `calc(${area.left} + ${randomX}%)`;
                leaf.style.top = `calc(${area.top} + ${randomY}%)`;
                
                // ç”Ÿæˆå¶å­ SVG
                const color = categoryColors[strength.category] || '#FFFFFF';
                leaf.innerHTML = generateLeafSVG(color, strength.count);
                
                // éšæœºæ—‹è½¬
                const rotation = -30 + Math.random() * 60;
                leaf.style.transform = `rotate(${rotation}deg)`;
                
                // ç‚¹å‡»äº‹ä»¶
                leaf.addEventListener('click', () => showStrengthDetails(index));
                
                document.querySelector('.leaves-container').appendChild(leaf);
                
            } catch (error) {
                console.error('Error adding leaf to tree:', error);
            }
        }

        // ç”Ÿç‰©å‘å…‰æ•ˆæœ
        function addBioLuminescence() {
            try {
                const leaves = document.querySelectorAll('.leaf');
                
                leaves.forEach(leaf => {
                    const numLights = 3 + Math.random() * 3;
                    
                    for (let i = 0; i < numLights; i++) {
                        const light = document.createElement('div');
                        light.classList.add('bio-luminescence');
                        
                        // åœ¨å¶å­å‘¨å›´éšæœºä½ç½®
                        const angle = Math.random() * Math.PI * 2;
                        const distance = 5 + Math.random() * 15;
                        
                        const x = Math.cos(angle) * distance;
                        const y = Math.sin(angle) * distance;
                        
                        light.style.left = `calc(50% + ${x}px)`;
                        light.style.top = `calc(50% + ${y}px)`;
                        
                        // éšæœºåŠ¨ç”»å»¶è¿Ÿ
                        light.style.animationDelay = `${Math.random() * 2}s`;
                        
                        leaf.appendChild(light);
                    }
                });
            } catch (error) {
                console.error('Error adding bio-luminescence:', error);
            }
        }

        // æ›´æ–°å¶å­æ ·å¼ - æ›´è‡ªç„¶çš„å½¢çŠ¶
        function generateLeafSVG(color, count) {
            return `
                <svg width="40" height="40" viewBox="0 0 100 100">
                    <path d="M50,10 C65,25 90,25 90,50 C90,75 65,85 50,90 C35,85 10,75 10,50 C10,25 35,25 50,10 Z" 
                          fill="${color}" 
                          filter="url(#leafGlow)" />
                    <text x="50" y="55" text-anchor="middle" fill="white" font-size="16" font-weight="bold">${count}</text>
                </svg>
            `;
        }

        // æ˜¾ç¤ºä¼˜ç‚¹è¯¦æƒ…
        function showStrengthDetails(index) {
            const strength = strengths[index];
            
            document.getElementById('detail-title').textContent = strength.name;
            document.getElementById('detail-description').textContent = strength.description;
            document.getElementById('detail-category').textContent = getCategoryName(strength.category);
            document.getElementById('detail-date').textContent = strength.date;
            document.getElementById('detail-count').textContent = strength.count;
            
            // ä¿å­˜å½“å‰æŸ¥çœ‹çš„ä¼˜ç‚¹ç´¢å¼•
            document.getElementById('add-progress').dataset.index = index;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('detail-modal').style.display = 'flex';
        }
        
        // è·å–åˆ†ç±»çš„ä¸­æ–‡åç§°
        function getCategoryName(category) {
            const categoryNames = {
                'social': 'ç¤¾äº¤èƒ½åŠ›',
                'academic': 'å­¦ä¹ èƒ½åŠ›',
                'emotional': 'æƒ…æ„Ÿç®¡ç†',
                'creative': 'åˆ›é€ åŠ›',
                'physical': 'ä½“èƒ½è¡¨ç°',
                'character': 'å“æ ¼ç‰¹è´¨'
            };
            
            return categoryNames[category] || category;
        }
        
        // æ·»åŠ ä¼˜ç‚¹
        document.getElementById('add-strength').addEventListener('click', () => {
            document.getElementById('add-modal').style.display = 'flex';
        });
        
        // ä¿å­˜ä¼˜ç‚¹
        document.getElementById('save-strength').addEventListener('click', async () => {
            const name = document.getElementById('strength-name').value.trim();
            const description = document.getElementById('strength-description').value.trim();
            const category = document.getElementById('strength-category').value;
            const date = document.getElementById('strength-date').value;
            
            if (!name || !description) {
                alert('è¯·å¡«å†™ä¼˜ç‚¹åç§°å’Œæè¿°');
                return;
            }
            
            // åˆ›å»ºæ–°ä¼˜ç‚¹
            const newStrength = {
                name,
                description,
                category,
                date,
                count: 1,
                progress: [{
                    description,
                    date
                }]
            };
            
            // æ·»åŠ åˆ°æ•°ç»„
            strengths.push(newStrength);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToLocalStorage('strengths', strengths);
            
            // å…³é—­æ¨¡æ€æ¡†å¹¶æ¸…ç©ºè¡¨å•
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('strength-name').value = '';
            document.getElementById('strength-description').value = '';
            document.getElementById('strength-date').valueAsDate = new Date();
            
            // åˆå§‹åŒ–æ ‘
            initTree();
            
            // æ£€æŸ¥æˆå°±
            checkAchievements(strengths.length, category);
        });
        
        // è®°å½•æ–°è¿›æ­¥
        document.getElementById('add-progress').addEventListener('click', async () => {
            const index = parseInt(document.getElementById('add-progress').dataset.index);
            
            // æç¤ºç”¨æˆ·è¾“å…¥æ–°è¿›æ­¥
            const progressDescription = prompt('è¯·æè¿°è¿™æ¬¡çš„è¿›æ­¥:');
            
            if (progressDescription && progressDescription.trim()) {
                // æ›´æ–°ä¼˜ç‚¹
                strengths[index].count++;
                strengths[index].progress.push({
                    description: progressDescription.trim(),
                    date: new Date().toISOString().split('T')[0]
                });
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveToLocalStorage('strengths', strengths);
                
                // æ›´æ–°è¯¦æƒ…æ˜¾ç¤º
                document.getElementById('detail-count').textContent = strengths[index].count;
                
                // è·å–å¶å­å…ƒç´ 
                const leafElement = document.querySelector(`.leaf[data-index="${index}"]`);
                
                // ä¿å­˜å½“å‰æ—‹è½¬è§’åº¦
                const currentTransform = getComputedStyle(leafElement).transform;
                const currentRotation = currentTransform !== 'none' 
                    ? Math.atan2(currentTransform.split(', ')[1], currentTransform.split(', ')[0]) * (180/Math.PI)
                    : 0;
                
                leafElement.style.setProperty('--initial-rotation', `${currentRotation}deg`);
                
                // æ·»åŠ è¿›æ­¥åŠ¨ç”»
                leafElement.classList.add('leaf-progress');
                
                // æ›´æ–°å¶å­ä¸Šçš„è®¡æ•°ï¼ˆåœ¨åŠ¨ç”»ä¸­é—´ç‚¹ï¼‰
                setTimeout(() => {
                    leafElement.querySelector('text').textContent = strengths[index].count;
                }, 1000);
                
                // æ£€æŸ¥æˆå°±
                checkAchievements(0, strengths[index].category, strengths[index].count);
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('detail-modal').style.display = 'none';
            }
        });
        
        // æŸ¥çœ‹æ‰€æœ‰ä¼˜ç‚¹
        document.getElementById('view-all').addEventListener('click', () => {
            const listElement = document.getElementById('strengths-list');
            listElement.innerHTML = '';
            
            if (strengths.length === 0) {
                listElement.innerHTML = '<p>è¿˜æ²¡æœ‰è®°å½•ä¼˜ç‚¹ï¼Œç‚¹å‡»"æ·»åŠ ä¼˜ç‚¹"å¼€å§‹è®°å½•å§ï¼</p>';
            } else {
                const categories = {};
                
                // æŒ‰åˆ†ç±»åˆ†ç»„
                strengths.forEach((strength, index) => {
                    if (!categories[strength.category]) {
                        categories[strength.category] = [];
                    }
                    categories[strength.category].push({...strength, index});
                });
                
                // éå†åˆ†ç±»åˆ›å»ºåˆ—è¡¨
                for (const category in categories) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<h3 style="color: ${categoryColors[category]}">${getCategoryName(category)}</h3>`;
                    
                    const strengthsList = document.createElement('ul');
                    categories[category].forEach(strength => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <a href="#" data-index="${strength.index}">${strength.name} (è¿›æ­¥æ¬¡æ•°: ${strength.count})</a>
                        `;
                        listItem.querySelector('a').addEventListener('click', (e) => {
                            e.preventDefault();
                            document.getElementById('all-strengths-modal').style.display = 'none';
                            showStrengthDetails(strength.index);
                        });
                        strengthsList.appendChild(listItem);
                    });
                    
                    categoryDiv.appendChild(strengthsList);
                    listElement.appendChild(categoryDiv);
                }
            }
            
            document.getElementById('all-strengths-modal').style.display = 'flex';
        });
        
        // æ£€æŸ¥æˆå°±
        function checkAchievements(totalStrengths, category, count) {
            let newAchievement = null;
            
            // æ•°é‡æˆå°±
            if (totalStrengths === 1 && !hasAchievement('first_strength')) {
                newAchievement = {
                    id: 'first_strength',
                    name: 'ç¬¬ä¸€æ¬¡å‘ç°',
                    description: 'è®°å½•äº†ç¬¬ä¸€ä¸ªä¼˜ç‚¹ï¼ç»§ç»­æ¢ç´¢æ›´å¤šå§ï¼'
                };
            } else if (totalStrengths === 5 && !hasAchievement('five_strengths')) {
                newAchievement = {
                    id: 'five_strengths',
                    name: 'å…‰èŠ’åˆç°',
                    description: 'å·²ç»å‘ç°äº†5ä¸ªä¼˜ç‚¹ï¼å­©å­æ­£åœ¨èŒå£®æˆé•¿ï¼'
                };
            } else if (totalStrengths === 10 && !hasAchievement('ten_strengths')) {
                newAchievement = {
                    id: 'ten_strengths',
                    name: 'é—ªè€€ä¹‹æ ‘',
                    description: 'å‘ç°äº†10ä¸ªä¼˜ç‚¹ï¼è¿™æ£µæ ‘çœŸæ˜¯å…‰å½©å¤ºç›®ï¼'
                };
            }
            
            // åˆ†ç±»æˆå°±
            if (category) {
                const categoryStrengths = strengths.filter(s => s.category === category).length;
                if (categoryStrengths === 3 && !hasAchievement(`${category}_expert`)) {
                    const categoryNames = {
                        'social': 'ç¤¾äº¤è¾¾äºº',
                        'academic': 'å­¦ä¹ èƒ½æ‰‹',
                        'emotional': 'æƒ…ç»ªç®¡ç†å¸ˆ',
                        'creative': 'åˆ›é€ å¤©æ‰',
                        'physical': 'è¿åŠ¨å¥å°†',
                        'character': 'å“æ ¼æ¥·æ¨¡'
                    };
                    
                    newAchievement = {
                        id: `${category}_expert`,
                        name: categoryNames[category],
                        description: `åœ¨${getCategoryName(category)}æ–¹é¢å‘ç°äº†3ä¸ªä¼˜ç‚¹ï¼`
                    };
                }
            }
            
            // è¿›æ­¥æ¬¡æ•°æˆå°±
            if (count === 5 && !hasAchievement('five_progress')) {
                newAchievement = {
                    id: 'five_progress',
                    name: 'æŒç»­è¿›æ­¥',
                    description: 'åœ¨ä¸€ä¸ªä¼˜ç‚¹ä¸Šå–å¾—äº†5æ¬¡è¿›æ­¥ï¼åšæŒçš„åŠ›é‡çœŸä¼Ÿå¤§ï¼'
                };
            } else if (count === 10 && !hasAchievement('ten_progress')) {
                newAchievement = {
                    id: 'ten_progress',
                    name: 'ç²¾ç›Šæ±‚ç²¾',
                    description: 'åœ¨ä¸€ä¸ªä¼˜ç‚¹ä¸Šå–å¾—äº†10æ¬¡è¿›æ­¥ï¼è¿™å·²ç»æˆä¸ºä¸€ç§ä¼˜ç§€çš„ä¹ æƒ¯ï¼'
                };
            }
            
            // å¦‚æœè·å¾—æ–°æˆå°±
            if (newAchievement) {
                achievements.push(newAchievement);
                saveToLocalStorage('achievements', achievements);
                showAchievementBanner(newAchievement);
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æˆå°±
        function hasAchievement(id) {
            return achievements.some(a => a.id === id);
        }
        
        // æ˜¾ç¤ºæˆå°±æ¨ªå¹…
        function showAchievementBanner(achievement) {
            const banner = document.getElementById('achievement-banner');
            document.getElementById('achievement-text').textContent = achievement.name + ' - ' + achievement.description;
            
            banner.style.display = 'block';
            
            // 5ç§’åéšè—
            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }
        
        // å…³é—­æŒ‰é’®
        document.getElementById('cancel-add').addEventListener('click', () => {
            document.getElementById('add-modal').style.display = 'none';
        });
        
        document.getElementById('close-detail').addEventListener('click', () => {
            document.getElementById('detail-modal').style.display = 'none';
        });
        
        document.getElementById('close-all').addEventListener('click', () => {
            document.getElementById('all-strengths-modal').style.display = 'none';
        });
        
        // æˆå°±ç³»ç»Ÿ
        document.getElementById('achievements').addEventListener('click', () => {
            const modal = document.createElement('div');
            modal.classList.add('modal');
            modal.style.display = 'flex';
            
            let content = `
                <div class="modal-content">
                    <h2>æˆå°±ç³»ç»Ÿ</h2>
            `;
            
            if (achievements.length === 0) {
                content += `<p>è¿˜æ²¡æœ‰è§£é”ä»»ä½•æˆå°±ã€‚ç»§ç»­è®°å½•å­©å­çš„ä¼˜ç‚¹ï¼Œå¾ˆå¿«å°±ä¼šæœ‰æƒŠå–œï¼</p>`;
            } else {
                content += `<ul>`;
                achievements.forEach(achievement => {
                    content += `<li><strong>${achievement.name}</strong> - ${achievement.description}</li>`;
                });
                content += `</ul>`;
            }
            
            content += `
                    <div class="btn-group">
                        <button id="close-achievements">å…³é—­</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
            
            document.getElementById('close-achievements').addEventListener('click', () => {
                modal.remove();
            });
        });
        
        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', () => {
            initTree();
        });
    </script>
</body>
</html>
